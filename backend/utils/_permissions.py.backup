"""
Role-Based Access Control (RBAC) utilities
Handles user roles and permissions
"""
from enum import Enum
from typing import List, Optional
from fastapi import HTTPException, status, Depends
from utils.jwt_auth import get_current_user_required


class UserRole(str, Enum):
    """User roles in the system"""
    USER = "user"           # Regular user
    CREATOR = "creator"     # Content creator
    MODERATOR = "moderator" # Platform moderator
    ADMIN = "admin"         # System administrator


class Permission(str, Enum):
    """System permissions"""
    # Content permissions
    CREATE_PODCAST = "create_podcast"
    EDIT_OWN_PODCAST = "edit_own_podcast"
    EDIT_ANY_PODCAST = "edit_any_podcast"
    DELETE_OWN_PODCAST = "delete_own_podcast"
    DELETE_ANY_PODCAST = "delete_any_podcast"
    
    # Moderation permissions
    MODERATE_COMMENTS = "moderate_comments"
    BAN_USERS = "ban_users"
    MANAGE_REPORTS = "manage_reports"
    
    # User permissions
    VIEW_ANALYTICS = "view_analytics"
    MANAGE_WEBHOOKS = "manage_webhooks"
    
    # Admin permissions
    MANAGE_USERS = "manage_users"
    MANAGE_ROLES = "manage_roles"
    VIEW_SYSTEM_STATS = "view_system_stats"


# Role permissions mapping
ROLE_PERMISSIONS: dict[UserRole, List[Permission]] = {
    UserRole.USER: [
        Permission.VIEW_ANALYTICS,
    ],
    UserRole.CREATOR: [
        Permission.CREATE_PODCAST,
        Permission.EDIT_OWN_PODCAST,
        Permission.DELETE_OWN_PODCAST,
        Permission.VIEW_ANALYTICS,
        Permission.MANAGE_WEBHOOKS,
    ],
    UserRole.MODERATOR: [
        Permission.CREATE_PODCAST,
        Permission.EDIT_OWN_PODCAST,
        Permission.EDIT_ANY_PODCAST,
        Permission.DELETE_OWN_PODCAST,
        Permission.VIEW_ANALYTICS,
        Permission.MANAGE_WEBHOOKS,
        Permission.MODERATE_COMMENTS,
        Permission.BAN_USERS,
        Permission.MANAGE_REPORTS,
    ],
    UserRole.ADMIN: [
        # Admins have all permissions
        perm for perm in Permission
    ]
}


def has_permission(user_role: str, permission: Permission) -> bool:
    """
    Check if a role has a specific permission
    
    Args:
        user_role: User's role as string
        permission: Permission to check
        
    Returns:
        True if role has permission
    """
    try:
        role = UserRole(user_role)
    except ValueError:
        return False
    
    return permission in ROLE_PERMISSIONS.get(role, [])


def has_any_permission(user_role: str, permissions: List[Permission]) -> bool:
    """Check if role has any of the specified permissions"""
    return any(has_permission(user_role, perm) for perm in permissions)


def has_all_permissions(user_role: str, permissions: List[Permission]) -> bool:
    """Check if role has all of the specified permissions"""
    return all(has_permission(user_role, perm) for perm in permissions)


def require_role(*allowed_roles: UserRole):
    """
    Dependency to require specific role(s)
    
    Usage:
        @router.get("/admin")
        async def admin_endpoint(user = Depends(require_role(UserRole.ADMIN))):
            ...
    """
    async def role_checker(current_user: dict = Depends(get_current_user_required)):
        user_role = current_user.get("role", "user")
        
        if user_role not in [role.value for role in allowed_roles]:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Access denied. Required roles: {', '.join(r.value for r in allowed_roles)}"
            )
        
        return current_user
    
    return role_checker


def require_permission(*required_permissions: Permission):
    """
    Dependency to require specific permission(s)
    
    Usage:
        @router.delete("/podcast/{id}")
        async def delete_podcast(
            user = Depends(require_permission(Permission.DELETE_ANY_PODCAST))
        ):
            ...
    """
    async def permission_checker(current_user: dict = Depends(get_current_user_required)):
        user_role = current_user.get("role", "user")
        
        if not has_all_permissions(user_role, list(required_permissions)):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Access denied. Missing permissions: {', '.join(p.value for p in required_permissions)}"
            )
        
        return current_user
    
    return permission_checker


def is_owner_or_has_permission(
    user_id: str,
    resource_owner_id: str,
    permission: Permission,
    user_role: str = "user"
) -> bool:
    """
    Check if user is the owner of resource OR has required permission
    
    Args:
        user_id: Current user ID
        resource_owner_id: ID of resource owner
        permission: Permission to check if not owner
        user_role: Current user's role
        
    Returns:
        True if user is owner or has permission
    """
    # User is owner
    if user_id == resource_owner_id:
        return True
    
    # User has permission
    return has_permission(user_role, permission)


async def check_ownership_or_permission(
    current_user: dict,
    resource_owner_id: str,
    permission: Permission,
    error_message: str = "Access denied"
):
    """
    Raise exception if user is not owner and doesn't have permission
    
    Args:
        current_user: Current user dict from JWT
        resource_owner_id: ID of resource owner
        permission: Required permission if not owner
        error_message: Custom error message
    """
    if not is_owner_or_has_permission(
        current_user["id"],
        resource_owner_id,
        permission,
        current_user.get("role", "user")
    ):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=error_message
        )
